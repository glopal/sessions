---
title: Sessions New Spec
type: analysis
summary: "Spec for the sessions new command redesign: three-mode dispatch with HEREDOC template, stdin parsing, and empty stub creation"
status: final
supersedes: null
---

# Spec: `sessions new` Command Redesign

## Overview

The `sessions new` command creates session files for the memory management system. The redesign introduces two modes of operation: a stub/empty mode for quick creation, and an interactive mode that outputs a HEREDOC prompt for Claude to complete in a single pass.

## Motivation

The current flow has two problems:

1. `git diff --name-status` only captures unstaged changes, missing untracked files entirely — requiring Claude to do a second pass to add them.
2. Claude must run `sessions new`, read the file, then make updates — a create-then-patch pattern that is unnecessary.

The new design flips this: Claude fills in the session content *before* the file is written, giving the CLI final authority over the full file structure.

## Modes

### `sessions new --empty`

Creates a stub session file immediately with no stdin interaction. All user-facing fields are set to empty defaults. Useful for quick session initialization when Claude context isn't needed.

**Output:** Writes the full session file directly.

### `sessions new` (default)

Outputs instructions and a HEREDOC template to stdout for Claude to complete. Claude fills in the template and pipes it back via stdin. The CLI reads stdin, merges the provided fields with system-managed fields, and writes the final file.

**Output:** Prints the following to stdout:

```
Run the following command with an updated HEREDOC.

sessions new <<SESS
---
summary: ""
tags: []
files_changed:
  - path: cmd/context.go
    action: modified
    summary: TODO
  - path: cmd/status.go
    action: deleted
    summary: TODO
  - path: bla
    action: added
    summary: TODO
---

## Key Decisions

- Decision 1 and rationale.

## Open Questions

- Anything unresolved that future sessions should be aware of.
SESS
```

`files_changed` is pre-populated using `git status --porcelain`, with `summary` set to `TODO` for each entry. Claude replaces the TODOs and fills in the other fields based on session context.

## Stdin / HEREDOC Flow

When `sessions new` receives stdin, it:

1. Parses the frontmatter fields from the input.
2. Accepts only the fields in the **Claude-settable fields** list (see below).
3. Merges them with system-managed fields.
4. Writes the complete session file.

This means Claude cannot overwrite system-managed fields even if they are included in the HEREDOC — the CLI ignores them.

## Field Ownership

### Claude-settable fields (accepted from stdin)

| Field | Type | Description |
|---|---|---|
| `summary` | string | Brief description of the session |
| `tags` | list of strings | Categorization tags |
| `files_changed` | list of objects | Files touched during the session |

Each entry in `files_changed`:

| Field | Type | Description |
|---|---|---|
| `path` | string | Relative file path |
| `action` | string | `modified`, `added`, `deleted`, `renamed` |
| `summary` | string | What changed and why |

### System-managed fields (set by CLI, ignored if provided via stdin)

| Field | Description |
|---|---|
| `timestamp` | Set to current time at file creation |
| `session_id` | Generated by CLI |
| `artifacts` | Initialized as empty list |
| `related_sessions` | Initialized as empty list |

## Output File

Session files are written to `.sessions/sessions/YYYY-MM/<session_id>.md`.

Full file structure:

```yaml
---
timestamp: 2026-02-24T14:32:50.861815-06:00
session_id: "1771965170"
summary: "Redesigned sessions new command"
tags:
  - sessions
  - cli
files_changed:
  - path: cmd/sessions.go
    action: modified
    summary: Added stdin support and HEREDOC prompt output
artifacts: []
related_sessions: []
---

## Key Decisions

- Decided to flip the creation flow so Claude writes content before the file is created, eliminating the create-then-patch pattern.

## Open Questions

- Should `sessions new --empty` also run `git status --porcelain` to pre-populate files_changed, or leave it truly empty?
```

## git status Integration

When generating the HEREDOC template, `sessions new` runs `git status --porcelain` and maps the output to `files_changed` entries:

| Porcelain code | `action` value |
|---|---|
| `M` | `modified` |
| `D` | `deleted` |
| `A` | `added` |
| `??` | `added` |
| `R` | `renamed` |

Claude is expected to review and adjust this list — adding files it knows changed that aren't tracked by git, removing irrelevant entries, and replacing `TODO` summaries with meaningful descriptions.

## Summary of Changes from Current Behavior

| | Before | After |
|---|---|---|
| File population | CLI writes file, Claude patches | Claude fills HEREDOC, CLI writes once |
| files_changed source | `git diff --name-status` (unstaged only) | `git status --porcelain` (all states) |
| Added files | Missed, Claude adds manually | Captured as `??` entries |
| System fields | Mixed with user fields | Strictly CLI-owned |
| Creation modes | One mode | `--empty` for stub, default for interactive |
